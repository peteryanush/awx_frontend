---
- name: install WEB server
  hosts: all
  become: yes
  gather_facts: False
  vars:

    aws_access_key: !vault |
           $ANSIBLE_VAULT;1.1;AES256
           64383865646531643963386233376234643262623730643038313362363865383463383838353265
           6338386261623832653230623837323462653734316333310a396534616666383031643836633864
           34373533653263353736393161643437303633323136613330643636373366323165303535643062
           3137303131653332620a373663343232333034313635373930643361656136353036366537613463
           32616464636663646130313339323633323939383439386235396630323337366564
    
    aws_secret_key: !vault |
           $ANSIBLE_VAULT;1.1;AES256
           35333533646135316430313664356132663464376334636164343765333164386435643232613231
           6464653238386635663839363333343333306164396433610a316131343335623237633263306234
           62653461333533396337336639336439643837383734393133343036643663656239363065323664
           3464656634393766610a376636353064333033336438613831666137623935623034303331383463
           38626261346131303061616438306265346164313834646164313132316632363731306236393432
           3530653630303661666665633064303437316663636439653539

  tasks:
    - name: install  epel-release
      yum:
        name:
          - epel-release

    - name: Install python for s3 delivery
      yum: 
        name:
          - python 
          - python-devel
          - python-pip
        state: present

    - name: Ensure boto and boto3 modules are installed
      pip:
         name: 
           - botocore
           - boto3

    - name: Find /var/log files equal or greater than 10 megabytes ending with .old or .log.gz
      find:
        paths: /opt/dfadmin/dforce-mobile/android/app/build/outputs/apk/alpha/release/
        patterns: '*.apk'
        size: 10m
      register: apk_out
    - debug:
        var: apk_out

    - name: Copy file to S3 bucket
      aws_s3:
          bucket: "ova-import-vm" 
          object: "{{ repo_mob_branch }}/"
          src: "/opt/dfadmin/dforce-mobile/android/app/build/outputs/apk/alpha/release/{{ apk_out }}"
          aws_access_key: "{{ aws_access_key }}"
          aws_secret_key: "{{ aws_secret_key }}"
#          dest: "apk-alpha"
          validate_certs: false
          mode: put
          encrypt: false
          debug_botocore_endpoint_logs: True
      ignore_errors: True
      no_log: false
